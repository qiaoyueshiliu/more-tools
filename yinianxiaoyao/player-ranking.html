<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具网站 - 玩家数据查询</title>
    <style>
        /* 保持原有样式不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "SimSun", sans-serif;
        }

        body {
            background-color: #f5f0e5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .site-title {
            font-size: 2.2rem;
            color: #8b5a2b;
            text-align: center;
            margin: 20px 0 30px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .search-filter {
            background-color: #fff8f0;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #6d4c41;
            font-weight: 500;
        }

        #apiBaseUrl {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0d0b5;
            border-radius: 4px;
            font-size: 1rem;
            background-color: #fff;
            color: #3e2723;
        }

        .param-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .param-item {
            flex: 1;
            min-width: 120px;
        }

        .param-item input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0d0b5;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* 在现有样式中添加 */
        .param-item select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0d0b5;
            border-radius: 4px;
            font-size: 1rem;
            background-color: #fff;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .fetch-btn {
            background-color: #d79e5b;
            color: #fff;
        }

        .fetch-btn:hover {
            background-color: #c88a45;
            transform: translateY(-1px);
        }

        .reset-btn {
            background-color: #8d6e63;
            color: #fff;
        }

        .reset-btn:hover {
            background-color: #795548;
        }

        .hint {
            font-size: 0.9rem;
            color: #8d6e63;
            margin-top: 8px;
            line-height: 1.5;
        }

        .result-section {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #fff8f0;
            border-bottom: 1px solid #f0e0c5;
        }

        .result-title {
            font-size: 1.2rem;
            color: #6d4c41;
            font-weight: 500;
        }

        .status {
            font-size: 0.9rem;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .status-loading {
            background-color: #fff3e0;
            color: #e65100;
        }

        .status-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }

        /* 方块式布局样式 */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .player-card {
            background-color: #fff8f0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .player-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 修改排名标识样式 */
        .rank-badge {
            position: absolute;
            top: -10px;
            left: 20px;
            padding: 4px 10px; /* 改为自适应宽度的内边距 */
            border-radius: 4px; /* 圆角方块 */
            color: white;
            display: inline-flex; /* 改为inline-flex适应内容宽度 */
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem; /* 稍微缩小字体 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 28px; /* 确保小数字时有基本宽度 */
            height: 28px; /* 固定高度保持一致性 */
        }

        /* 保持原有的排名颜色样式 */
        .rank-1 {
            background-color: #e67e22;
        }

        .rank-2 {
            background-color: #3498db;
        }

        .rank-3 {
            background-color: #8e44ad;
        }

        .rank-other {
            background-color: #8d6e63;
        }

        .player-header {
            margin-top: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3e2723;
            margin-bottom: 5px;
        }

        .job-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: white;
        }

        .job-gui {
            background-color: #9b59b6;
        }

        /* 鬼 */
        .job-jian {
            background-color: #f39c12;
        }

        /* 剑 */
        .job-other {
            background-color: #42a5f5;
        }

        /* 其他 */

        .player-stats {
            background-color: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #f0e0c5;
            font-size: 0.9rem;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #795548;
        }

        .stat-value {
            color: #c62828;
            font-weight: 500;
        }

        .labels-container {
            margin-top: 10px;
        }

        .label-item {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            color: white;
        }

        .update-time {
            font-size: 0.8rem;
            color: #a1887f;
            text-align: right;
            margin-top: 10px;
        }

        .empty, .error-message {
            padding: 30px 20px;
            text-align: center;
        }

        .empty {
            color: #8d6e63;
            background-color: #fff8f0;
        }

        .error-message {
            color: #c62828;
            background-color: #fff3f3;
            line-height: 1.6;
        }

        pre {
            padding: 15px;
            background-color: #fff8f0;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
            color: #3e2723;
            line-height: 1.5;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background-color: #fff8f0;
        }

        .pagination-btn {
            padding: 5px 12px;
        }

        /* 在样式部分添加各职业的颜色 */
        .job-fa {
            background-color: #42a5f5;
        }

        /* 法修 -  */
        .job-ti {
            background-color: #ff4500;
        }

        /* 体修 -  */
        .job-jian {
            background-color: #ffb142;
        }

        /* 剑修 -  */
        .job-gui {
            background-color: #9b59b6;
        }

        /* 鬼修 -  */
        .job-ru {
            background-color: #225550;
        }

        /* 儒修 -  */
        .job-other {
            background-color: #78909c;
        }

        /* 其他 - 灰色 */

        @media (max-width: 600px) {
            .site-title {
                font-size: 1.8rem;
            }

            .player-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="site-title">逍遥战力榜 (官方暂未开通大罗信息) </h1>

    <div class="search-filter">
        <div class="input-group">
            <label for="apiBaseUrl">接口基础地址</label>
            <input
                    type="text"
                    id="apiBaseUrl"
                    value="https://www.swallaws.com/xian/box/api/player/find"
                    placeholder="输入玩家数据接口基础地址"
            >
        </div>

        <div class="param-group">
            <div class="param-item">
                <label for="sort">排序</label>
                <input type="number" id="sort" value="0" min="0">
            </div>
            <div class="param-item">
                <label for="page">页码</label>
                <input type="number" id="page" value="1" min="1">
            </div>
            <div class="param-item">
                <label for="size">每页条数</label>
                <input type="number" id="size" value="10" min="1" max="100">
            </div>
            <!-- 在param-group中添加新的参数项 -->
            <div class="param-item">
                <label for="name">名称</label>
                <input type="text" id="name" placeholder="名称">
            </div>
            <div class="param-item">
                <label for="job">职业</label>
                <select id="job" class="param-item input">
                    <option value="">全部</option>
                    <option value="fa">法修</option>
                    <option value="ti">体修</option>
                    <option value="jian">剑修</option>
                    <option value="gui">鬼修</option>
                    <option value="ru">儒修</option>
                </select>
            </div>
            <!-- 在param-group中添加等级选择下拉框 -->
            <div class="param-item">
                <label for="level">境界</label>
                <select id="level" class="param-item input">
                    <option value="">全部</option>
                    <option value="2">练气</option>
                    <option value="3">筑基</option>
                    <option value="4">结丹</option>
                    <option value="5">元婴</option>
                    <option value="6">化神</option>
                    <option value="7">返虚</option>
                    <option value="8">合体</option>
                    <option value="9">大乘</option>
                    <option value="10">渡劫</option>
                    <option value="11">真仙</option>
                    <option value="12">金仙</option>
                    <option value="13">太乙</option>
                    <option value="14">大罗</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn fetch-btn" onclick="fetchApiData()">获取玩家数据</button>
                <button class="btn reset-btn" onclick="resetApiParams()">恢复默认参数</button>
            </div>

            <div class="hint">
                1. 接口参数将自动拼接在基础地址后<br>
                2. 跨域错误？尝试添加代理前缀：https://cors-anywhere.herokuapp.com/
            </div>
        </div>

        <div class="result-section">
            <div class="result-header">
                <div class="result-title">玩家排行榜数据</div>
                <div class="status" id="status">未请求</div>
            </div>
            <div id="resultArea" class="empty">点击"获取玩家数据"按钮加载排行榜</div>
            <div id="pagination" class="pagination" style="display: none;">
                <button class="btn pagination-btn" onclick="changePage(-1)">上一页</button>
                <span id="pageInfo">第 1 页</span>
                <button class="btn pagination-btn" onclick="changePage(1)">下一页</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_API_BASE_URL = "https://www.swallaws.com/xian/box/api/player/find";
        const DEFAULT_SORT = 0;
        const DEFAULT_PAGE = 1;
        const DEFAULT_SIZE = 10;
        // 在JavaScript部分添加职业映射关系
        const jobMapping = {
            "fa": {className: "job-fa", name: "法修"},
            "ti": {className: "job-ti", name: "体修"},
            "jian": {className: "job-jian", name: "剑修"},
            "gui": {className: "job-gui", name: "鬼修"},
            "ru": {className: "job-ru", name: "儒修"},
            "default": {className: "job-other", name: "未知职业"}
        };
        // 在JavaScript部分添加境界映射关系
        // 在原有JavaScript部分添加职业对应的境界映射表
        const levelMappingByJob = {
            // 体修(金相)境界
            "ti": {
                "2": "通脉",
                "3": "锻骨",
                "4": "炼腑",
                "5": "元武",
                "6": "神力",
                "7": "破虚",
                "8": "混元",
                "9": "大成",
                "10": "涅槃",
                "11": "真武",
                "12": "金相",
                "13": "太上",
                "14": "罗天"
            },
            // 法修(金仙)境界
            "fa": {
                "2": "练气",
                "3": "筑基",
                "4": "结丹",
                "5": "元婴",
                "6": "化神",
                "7": "返虚",
                "8": "合体",
                "9": "大乘",
                "10": "渡劫",
                "11": "真仙",
                "12": "金仙",
                "13": "太乙",
                "14": "大罗"
            },
            // 剑修境界
            "jian": {
                "2": "驭剑",
                "3": "塑灵",
                "4": "炼意",
                "5": "元罡",
                "6": "通明",
                "7": "碎虚",
                "8": "归元",
                "9": "剑成",
                "10": "开天",
                "11": "剑仙",
                "12": "万相",
                "13": "太一",
                "14": "无极"
            },
            // 鬼修境界
            "gui": {
                "2": "聚魂",
                "3": "凝魄",
                "4": "鬼丹",
                "5": "元冥",
                "6": "通幽",
                "7": "归虚",
                "8": "合冥",
                "9": "煞成",
                "10": "阳劫",
                "11": "鬼仙",
                "12": "金魄",
                "13": "太阴",
                "14": "阎罗"
            },
            // 儒修境界
            "ru": {
                "2": "开窍",
                "3": "凝识",
                "4": "文胆",
                "5": "才心",
                "6": "明神",
                "7": "致虚",
                "8": "合德",
                "9": "文成",
                "10": "立命",
                "11": "儒仙",
                "12": "玉璞",
                "13": "太和",
                "14": "圣贤"
            },
            // 默认境界（未知职业）
            "default": {
                "2": "练气",
                "3": "筑基",
                "4": "结丹",
                "5": "元婴",
                "6": "化神",
                "7": "返虚",
                "8": "合体",
                "9": "大乘",
                "10": "渡劫",
                "11": "真仙",
                "12": "金仙",
                "13": "太乙",
                "14": "大罗"
            }
        };

        // 恢复默认参数
        function resetApiParams() {
            document.getElementById("apiBaseUrl").value = DEFAULT_API_BASE_URL;
            document.getElementById("sort").value = DEFAULT_SORT;
            document.getElementById("page").value = DEFAULT_PAGE;
            document.getElementById("size").value = DEFAULT_SIZE;
            // 重置新添加的字段
            document.getElementById("name").value = "";
            document.getElementById("level").value = "";
            document.getElementById("job").value = "";
        }

        // 切换页码
        function changePage(direction) {
            const pageInput = document.getElementById("page");
            let currentPage = parseInt(pageInput.value, 10) || 1;
            const newPage = currentPage + direction;

            if (newPage >= 1) {
                pageInput.value = newPage;
                fetchApiData();
            }
        }

        // 构建完整API地址
        function buildApiUrl() {
            const baseUrl = document.getElementById("apiBaseUrl").value.trim();
            const sort = document.getElementById("sort").value.trim();
            const page = document.getElementById("page").value.trim();
            const size = document.getElementById("size").value.trim();
            // 获取新添加的参数
            const name = document.getElementById("name").value.trim();
            const level = document.getElementById("level").value.trim();
            const job = document.getElementById("job").value.trim();

            // 验证必要参数
            if (!baseUrl) return null;
            if (!sort || isNaN(sort)) return null;
            if (!page || isNaN(page) || parseInt(page) < 1) return null;
            if (!size || isNaN(size) || parseInt(size) < 1) return null;

            // 构建查询参数
            const params = new URLSearchParams();
            params.append('sort', sort);
            params.append('page', page);
            params.append('size', size);

            // 添加新参数（只在有值时添加）
            if (name) params.append('name', name);
            if (level) params.append('level', level);
            if (job) params.append('job', job);

            // 拼接基础URL和参数
            return baseUrl.includes('?')
                ? `${baseUrl}&${params.toString()}`
                : `${baseUrl}?${params.toString()}`;
        }

        async function fetchApiData() {
            const apiUrl = buildApiUrl();
            const resultArea = document.getElementById("resultArea");
            const statusElement = document.getElementById("status");
            const pagination = document.getElementById("pagination");
            const pageInfo = document.getElementById("pageInfo");
            const currentPage = document.getElementById("page").value;

            // 验证API地址
            if (!apiUrl) {
                statusElement.className = "status status-error";
                statusElement.textContent = "输入错误";
                resultArea.innerHTML = '<div class="error-message">请输入有效的接口参数</div>';
                pagination.style.display = "none";
                return;
            }

            // 显示加载状态
            statusElement.className = "status status-loading";
            statusElement.textContent = "加载中...";
            resultArea.innerHTML = '<div class="empty">正在获取玩家数据，请稍候...</div>';
            pagination.style.display = "none";

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`请求失败（状态码：${response.status}）`);
                }
                const data = await response.json();
                console.log("接口返回数据：", data);

                statusElement.className = "status status-success";
                statusElement.textContent = "加载成功";

                // 适配数据格式
                if (data.code === 200 && data.data && data.data.length > 0) {
                    const players = data.data;
                    let html = '<div class="player-grid">';

                    players.forEach(player => {
                        // 排名样式
                        const rank = player.rank || 0;
                        let rankClass = "rank-other";
                        if (rank === 1) rankClass = "rank-1";
                        else if (rank === 2) rankClass = "rank-2";
                        else if (rank === 3) rankClass = "rank-3";

                        // 替换原来的职业处理代码
                        let jobInfo = jobMapping[player.job] || jobMapping.default;
                        let jobClass = jobInfo.className;
                        let jobText = jobInfo.name;

                        // 替换原来的境界处理代码
                        // 获取该职业对应的境界映射表
                        const jobType = player.job || "default";
                        const jobLevels = levelMappingByJob[jobType] || levelMappingByJob["default"];
                        // 获取境界名称，如果找不到则显示等级数值
                        const levelText = jobLevels[player.level] || `等级${player.level}`;

                        // 标签处理
                        let labelsHtml = "";
                        if (player.labels && player.labels.length > 0) {
                            player.labels.forEach(label => {
                                labelsHtml += `<span class="label-item" style="background-color: rgb(${label.color})">${label.name}</span>`;
                            });
                        }

                        // 替换原来的战力格式化代码
                        const formattedCombat = formatNumberWithUnits(player.combat);

                        // 卡片HTML
                        html += `
                        <div class="player-card">
                            <div class="rank-badge ${rankClass}">${rank}</div>
                            <div class="player-header">
                                <div class="player-name">${player.name || "无名玩家"}</div>
                                <span class="job-tag ${jobClass}">${jobText}</span>
                            </div>
                            <div class="player-stats">
                                <div class="stat-item">
                                    <span class="stat-label">职业</span>
                                    <span class="stat-value">${jobText}</span>
                                </div>
                                <!-- 替换等级显示部分 -->
                                <div class="stat-item">
                                    <span class="stat-label">境界</span>
                                    <span class="stat-value">${levelText}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">战力</span>
                                    <span class="stat-value">${formattedCombat}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">区服</span>
                                    <span class="stat-value">${player.serverName || "未知"}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">宗门</span>
                                    <span class="stat-value">${player.gangName || "无"}</span>
                                </div>
                            </div>
                            <div class="labels-container">
                                ${labelsHtml}
                            </div>
                            <div class="update-time">${player.updateTime || "刚刚更新"}</div>
                        </div>
                    `;
                    });

                    html += '</div>';
                    resultArea.innerHTML = html;
                    // 显示分页控件
                    pagination.style.display = "flex";
                    pageInfo.textContent = `第 ${currentPage} 页`;

                } else {
                    resultArea.innerHTML = `
                    <div style="padding:15px; color:#8d6e63;">
                        数据格式未匹配，展示原始数据：
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                    pagination.style.display = "none";
                }

            } catch (error) {
                statusElement.className = "status status-error";
                statusElement.textContent = "加载失败";

                let errorMsg = error.message;
                if (errorMsg.includes("CORS")) {
                    errorMsg += `
                    <br><br>跨域解决方案：
                    1. 在接口前添加代理：<br>
                    https://cors-anywhere.herokuapp.com/${apiUrl}
                    <br><br>2. 安装浏览器跨域插件（如Allow CORS）
                `;
                }
                resultArea.innerHTML = `<div class="error-message">${errorMsg}</div>`;
                pagination.style.display = "none";
                console.error("错误详情：", error);
            }
        }

        // 数字格式化：转换为带汉字单位的格式（万、亿、兆）
        // 数字格式化：保留完整数值并插入单位分隔符（兆、亿、万）
        function formatNumberWithUnits(num) {
            // 处理非数字情况
            if (isNaN(num) || num === null || num === undefined) return "0";

            // 转换为字符串处理
            let str = Math.floor(num).toString();
            let result = [];

            // 从右向左每4位一组处理
            while (str.length > 0) {
                // 最后一组可能不足4位
                const chunk = str.length >= 4 ? str.slice(-4) : str;
                result.unshift(chunk);
                // 截取剩余部分
                str = str.slice(0, str.length - 4);
            }

            // 定义单位（从大到小）
            const units = ['兆 ', '亿 ', '万 ', ''];
            // 计算需要使用的单位起始索引
            const unitStartIndex = units.length - result.length;

            // 拼接结果
            let formatted = '';
            result.forEach((chunk, index) => {
                // 只在非零 chunk 后添加单位
                const unit = units[unitStartIndex + index];
                formatted += chunk + (chunk !== '0000' ? unit : '');
            });

            // 处理特殊情况（如全零）
            return formatted || '0';
        }
    </script>
</body>
</html>